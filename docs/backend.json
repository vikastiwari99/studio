{
  "entities": {
    "Guardian": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Guardian",
      "type": "object",
      "description": "Represents a parent or guardian who oversees student activity and receives problem statements.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the guardian entity."
        },
        "email": {
          "type": "string",
          "description": "Email address of the guardian.",
          "format": "email"
        },
        "passwordHash": {
          "type": "string",
          "description": "Hashed password for guardian authentication.  Note:  Storing password hashes directly is discouraged.  Consider using a secure authentication service instead."
        },
        "studentIds": {
          "type": "array",
          "description": "References to Students. (Relationship: Guardian 1:N Student)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "email",
        "passwordHash"
      ]
    },
    "Student": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Student",
      "type": "object",
      "description": "Represents a student using the MathMentorAI application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the student entity."
        },
        "gradeLevel": {
          "type": "string",
          "description": "The student's grade level."
        },
        "preferredTopics": {
          "type": "array",
          "description": "An array of the student's preferred math topics.",
          "items": {
            "type": "string"
          }
        },
        "difficultyLevel": {
          "type": "string",
          "description": "The student's preferred difficulty level (Basic, Moderate, Complex)."
        },
        "guardianId": {
          "type": "string",
          "description": "Reference to Guardian. (Relationship: Guardian 1:N Student)"
        }
      },
      "required": [
        "id",
        "gradeLevel",
        "difficultyLevel",
        "guardianId"
      ]
    },
    "Problem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Problem",
      "type": "object",
      "description": "Represents a math problem generated by the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the problem entity."
        },
        "problemStatement": {
          "type": "string",
          "description": "The text of the math problem."
        },
        "topic": {
          "type": "string",
          "description": "The math topic the problem belongs to (e.g., Multiplication, Division)."
        },
        "difficultyLevel": {
          "type": "string",
          "description": "The difficulty level of the problem (Basic, Moderate, Complex)."
        },
        "solution": {
          "type": "string",
          "description": "The complete solution to the math problem."
        },
        "studentId": {
          "type": "string",
          "description": "Reference to Student. (Relationship: Student 1:N Problem)"
        }
      },
      "required": [
        "id",
        "problemStatement",
        "topic",
        "difficultyLevel",
        "solution",
        "studentId"
      ]
    },
    "ProblemView": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ProblemView",
      "type": "object",
      "description": "Records when a guardian views the full solution to a problem, triggering an email notification.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the problem view event."
        },
        "problemId": {
          "type": "string",
          "description": "Reference to Problem. (Relationship: Problem 1:N ProblemView)"
        },
        "guardianId": {
          "type": "string",
          "description": "Reference to Guardian. (Relationship: Guardian 1:N ProblemView)"
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the solution was viewed.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "problemId",
        "guardianId",
        "timestamp"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/guardians/{guardianId}",
        "definition": {
          "entityName": "Guardian",
          "schema": {
            "$ref": "#/backend/entities/Guardian"
          },
          "description": "Stores guardian profiles. PasswordHash is stored here. Consider using Firebase Authentication service instead.",
          "params": [
            {
              "name": "guardianId",
              "description": "The unique identifier for the guardian."
            }
          ]
        }
      },
      {
        "path": "/guardians/{guardianId}/students/{studentId}",
        "definition": {
          "entityName": "Student",
          "schema": {
            "$ref": "#/backend/entities/Student"
          },
          "description": "Stores student profiles, nested under their guardian.  This facilitates path-based ownership.",
          "params": [
            {
              "name": "guardianId",
              "description": "The unique identifier for the guardian."
            },
            {
              "name": "studentId",
              "description": "The unique identifier for the student."
            }
          ]
        }
      },
      {
        "path": "/guardians/{guardianId}/students/{studentId}/problems/{problemId}",
        "definition": {
          "entityName": "Problem",
          "schema": {
            "$ref": "#/backend/entities/Problem"
          },
          "description": "Stores math problems associated with a specific student. Includes studentId for rule enforcements. Denormalized from student profile",
          "params": [
            {
              "name": "guardianId",
              "description": "The unique identifier for the guardian."
            },
            {
              "name": "studentId",
              "description": "The unique identifier for the student."
            },
            {
              "name": "problemId",
              "description": "The unique identifier for the problem."
            }
          ]
        }
      },
      {
        "path": "/problemViews/{problemViewId}",
        "definition": {
          "entityName": "ProblemView",
          "schema": {
            "$ref": "#/backend/entities/ProblemView"
          },
          "description": "Stores records of when a guardian views a problem solution. Triggers email notification. This collection is separate to improve security and performance and make rule creation easier.",
          "params": [
            {
              "name": "problemViewId",
              "description": "The unique identifier for the problem view event."
            }
          ]
        }
      }
    ],
    "reasoning": "This Firestore structure is designed to support MathMentorAI's core features while adhering to the principles of Authorization Independence, Structural Segregation, Access Modeling, and Data Clarity. Login is managed at the guardian level, with students associated with guardians. Problem statements and solutions are linked to students, and a separate collection tracks when guardians view solutions.\n\n**Authorization Independence:**\nGuardians manage student accounts.  `Problem` documents store the `studentId`. This allows rules to enforce that a guardian can only view solutions for problems associated with their students, without needing to perform `get()` operations to traverse the hierarchy.\n\n**Structural Segregation:**\nEach collection serves a distinct purpose and has its own security posture.  Guardians and Students are stored in separate collections, allowing for different access controls.\n\n**Access Modeling:**\nPath-based ownership is used for students and their problems (`/guardians/{guardianId}/students/{studentId}/problems/{problemId}`). The `ProblemView` collection facilitates tracking access and triggering email notifications.\n\n**QAPs (Rules are not Filters):**\nThe structure enables secure list operations because the rules can verify the relationship between the logged-in user and the data being requested. A guardian can securely list only their students. The structure also ensures that a guardian cannot list `problems` or `problemViews` for any student other than those associated with them because the `studentId` field is directly accessible for rule enforcement and is incorporated as part of the path hierarchy.\n\n**Email Notifications:**\nWrites to the `problemViews` collection trigger a Firebase Function that sends an email to the guardian containing the problem statement."
  }
}